volumes:
  public_assets: {}
  nginx-logs: {}
  certbot-etc: {}

services:
  app:
    volumes:
      - public_assets:/var/www/public
    ports:
      - '8088:8088'
    restart: always

  webserver:
    image: nginx:1.25.4-alpine
    container_name: perfumarte-nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - './docker/production/nginx:/etc/nginx/conf.d:ro'
      - './certbot/conf:/etc/letsencrypt:ro'
      - './certbot/www:/var/www/certbot'
      - public_assets:/var/www/public:ro
      - nginx-logs:/var/log/nginx
    command: /bin/sh -c 'rm -f /etc/nginx/conf.d/default.conf && nginx -g "daemon off;"'
    depends_on:
      - app

  fail2ban:
    image: crazymax/fail2ban:latest
    container_name: perfumarte-fail2ban
    restart: unless-stopped
    network_mode: "host"
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ./docker/production/fail2ban:/data
      - nginx-logs:/var/log/nginx:ro
    depends_on:
      - webserver